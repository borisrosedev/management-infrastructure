\documentclass[11pt,a4paper]{article}

% --- Encoding & fonts ---
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}

% --- Page layout ---
\usepackage[margin=2.5cm]{geometry}

% --- Colors & hyperlinks ---
\usepackage{xcolor}
\definecolor{linkcolor}{HTML}{0A66C2}
\usepackage[colorlinks=true,linkcolor=linkcolor,urlcolor=linkcolor,citecolor=linkcolor]{hyperref}

% --- Code listings ---
\usepackage{listings}
\lstdefinelanguage{bash}{
  sensitive=true,
  morecomment=[l]{\#},
  morestring=[b]",
}
\lstset{
  language=bash,
  basicstyle=\ttfamily\small,
  numbers=left,
  numberstyle=\scriptsize\color{gray},
  stepnumber=1,
  numbersep=8pt,
  showstringspaces=false,
  columns=fullflexible,
  keepspaces=true,
  tabsize=2,
  breaklines=true,
  frame=single,
  rulecolor=\color{black!20},
  keywordstyle=\bfseries\color{black},
  commentstyle=\itshape\color{gray!70},
  stringstyle=\color{teal!70!black},
}

% --- Niceties ---
\usepackage{enumitem}
\setlist[itemize]{nosep,left=0pt..1.5em}
\setlist[enumerate]{nosep,left=0pt..1.5em}

\title{Explication d√©taill√©e, ligne par ligne, d'un script Bash de recherche}
\author{%
Script: \texttt{search\_mtime}, \texttt{find\_suspects}, \texttt{search\_for\_type}
}
\date{}

\begin{document}
\maketitle
\tableofcontents

\section{Script complet (avec num√©ros de ligne)}
\label{sec:script}
\begin{lstlisting}
#!/usr/bin/env bash
set -Eeuo pipefail
IFS=$'\n\t'

WORKING_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"

# shellcheck source=./constants.sh
if [[ -f "$WORKING_DIR/constants.sh" ]]; then
  # shellcheck disable=SC1091
  source "$WORKING_DIR/constants.sh"
else
  CYAN_COLOR=""
  RED_COLOR=""
  NO_COLOR=""
fi

search_mtime() {
    printf "üöÄ%s searching files edited within 24h : %s\n" "${CYAN_COLOR:-}" "${NO_COLOR:-}"
    find . -type f -mtime -1 -print
}

find_suspects() {
    local ext=${1:-}
    if [[ -z "$ext" ]]; then
        printf "Usage: %s <extension>\n" "${FUNCNAME[0]}"
        return 2
    fi
    printf "üöÄ%s searching suspect files with .%s extension : %s\n" "${RED_COLOR:-}" "$ext" "${NO_COLOR:-}"
    find . -type f -iname "*.${ext}" -print0 \
      | xargs -0 -r grep -HnEI -- 'malware|virus|worm' || true
}

search_for_type() {
    local ext=${1:-}
    if [[ -z "$ext" ]]; then
        printf "Usage: %s <extension>\n" "${FUNCNAME[0]}"
        return 2
    fi
    printf "üöÄsearch for type => %s :\n" "$ext"
    find . -type f -iname "*.${ext}"
}

# case "${1:-}" in
#   mtime)        search_mtime ;;
#   suspects)     shift; find_suspects "${1:-}" ;;
#   type)         shift; search_for_type "${1:-}" ;;
#   *)            printf "Usage: %s {mtime|suspects <ext>|type <ext>}\n" "$0"; exit 1 ;;
# esac
\end{lstlisting}

\section{Explication ligne par ligne}
Les r√©f√©rences aux num√©ros (\emph{L\#}) renvoient aux lignes list√©es en section~\ref{sec:script}.

\subsection*{En-t√™te et garde-fous du shell : L1--L3}
\begin{enumerate}
  \item[\textbf{L1}] \texttt{\#! /usr/bin/env bash} : Shebang. Demande √† l'OS d'ex√©cuter ce fichier avec \texttt{bash} trouv√© via \texttt{env}. Plus portable que \texttt{\#!/bin/bash}.
  \item[\textbf{L2}] \texttt{set -Eeuo pipefail} : Active des protections essentielles :
  \begin{itemize}
    \item \texttt{-E} : propage les traps \texttt{ERR} dans les fonctions/sous-shells.
    \item \texttt{-e} : quitte si une commande renvoie un code non nul (sauf cas contr√¥l√©s).
    \item \texttt{-u} : erreur si une variable non d√©finie est r√©f√©renc√©e.
    \item \texttt{pipefail} : un pipeline √©choue si \emph{n'importe quel} maillon √©choue (et pas seulement le dernier).
  \end{itemize}
  \item[\textbf{L3}] \texttt{IFS=\$'\textbackslash n\textbackslash t'} : red√©finit le s√©parateur de champs interne au retour-ligne et tabulation. √âvite les d√©coupes hasardeuses sur les espaces dans les chemins.
\end{enumerate}

\subsection*{R√©solution fiable du dossier du script : L5}
\begin{enumerate}
  \item[\textbf{L5}] \texttt{WORKING\_DIR="...\$ \{BASH\_SOURCE[0]\}..."} :
  \begin{itemize}
    \item \texttt{\$\{BASH\_SOURCE[0]\}} : chemin du \emph{fichier} courant (plus robuste que \texttt{\$0} si le script est \emph{sourc√©}).
    \item \texttt{dirname -- "..."} : isole le dossier parent. Le \texttt{--} prot√®ge si le chemin commence par \texttt{-}.
    \item \texttt{cd -- "..."\ \&\&\ pwd -P} : se place dans ce dossier puis affiche le chemin \emph{physique} (r√©solution des liens symboliques) et l'enregistre dans \texttt{WORKING\_DIR}.
  \end{itemize}
\end{enumerate}

\subsection*{Chargement optionnel des constantes : L7--L15}
\begin{enumerate}
  \item[\textbf{L7}] Commentaire \texttt{shellcheck source=./constants.sh} : aide l'outil \emph{ShellCheck} √† localiser le fichier sourc√©.
  \item[\textbf{L8}] \texttt{if [[ -f "\$WORKING\_DIR/constants.sh" ]]} : on charge le fichier de constantes s'il existe dans le m√™me dossier.
  \item[\textbf{L9}] \texttt{\# shellcheck disable=SC1091} : d√©sactive un avertissement (fichier non d√©tectable statiquement).
  \item[\textbf{L10}] \texttt{source "\$WORKING\_DIR/constants.sh"} : importe les variables/fonctions (typiquement, couleurs ANSI).
  \item[\textbf{L11--L15}] Sinon, d√©finit des \emph{fallbacks} vides pour \texttt{CYAN\_COLOR}, \texttt{RED\_COLOR}, \texttt{NO\_COLOR} afin d'√©viter toute r√©f√©rence de variable non d√©finie (\texttt{set -u}).
\end{enumerate}

\subsection*{\texttt{search\_mtime} : L17--L20}
\begin{enumerate}
  \item[\textbf{L17}] D√©claration de la fonction.
  \item[\textbf{L18}] \texttt{printf "üöÄ\%s ... \%s\textbackslash n" "\$\{CYAN\_COLOR:-\}" "\$\{NO\_COLOR:-\}"} :
  \begin{itemize}
    \item \texttt{printf} est plus pr√©visible que \texttt{echo -e}.
    \item \texttt{\$\{VAR:-\}} injecte une valeur vide si la variable n'est pas d√©finie.
  \end{itemize}
  \item[\textbf{L19}] \texttt{find . -type f -mtime -1 -print} :
  \begin{itemize}
    \item \texttt{-type f} : fichiers uniquement.
    \item \texttt{-mtime -1} : modifi√©s dans les derni√®res 24 heures.
    \item \texttt{-print} : affiche les chemins.
  \end{itemize}
  \item[\textbf{L20}] Fin de la fonction.
\end{enumerate}

\subsection*{\texttt{find\_suspects} : L22--L31}
\begin{enumerate}
  \item[\textbf{L22}] D√©claration de la fonction.
  \item[\textbf{L23}] \texttt{local ext=\$\{1:-\}} : r√©cup√®re l'extension pass√©e en premier argument (vide si absent).
  \item[\textbf{L24--L27}] Si l'argument est vide, affiche un \emph{usage} et retourne le code 2 (mauvais usage).
  \item[\textbf{L28}] En-t√™te color√© \emph{(si couleurs disponibles)} avec l'extension cibl√©e.
  \item[\textbf{L29--L30}] Recherche et filtrage :
  \begin{itemize}
    \item \texttt{find . -type f -iname "*.\$\{ext\}" -print0} : liste les fichiers de l'extension (casse insensible), en s√©parant les r√©sultats par NUL (\texttt{-print0}) pour √™tre s√ªr m√™me si les chemins contiennent espaces/retours-ligne.
    \item \texttt{| xargs -0 -r grep -HnEI -- 'malware|virus|worm'} :
      \begin{itemize}
        \item \texttt{-0} : lit des chemins s√©par√©s par NUL.
        \item \texttt{-r} : n'ex√©cute rien si l'entr√©e est vide (√©vite \texttt{grep} sans argument).
        \item \texttt{grep -HnEI} :
          \begin{itemize}
            \item \texttt{-H} : affiche toujours le nom de fichier.
            \item \texttt{-n} : affiche le num√©ro de ligne.
            \item \texttt{-E} : expressions r√©guli√®res √©tendues (pour le \texttt{|} alternation).
            \item \texttt{-I} : ignore les fichiers binaires.
            % \item \texttt{-i} (optionnel) : √† ajouter si vous voulez une recherche \emph{insensible √† la casse} dans le \emph{texte} (ici, seul \texttt{-I} vise les binaires).
          \end{itemize}
        \item motif \texttt{'malware|virus|worm'} : cherche l'un de ces termes.
      \end{itemize}
    \item \texttt{|| true} : en cas d'absence de correspondance, \texttt{grep} renvoie 1. Cette clause emp√™che \texttt{set -e} d'arr√™ter le script.
  \end{itemize}
  \item[\textbf{L31}] Fin de la fonction.
\end{enumerate}

\subsection*{\texttt{search\_for\_type} : L33--L41}
\begin{enumerate}
  \item[\textbf{L33}] D√©claration de la fonction.
  \item[\textbf{L34}] \texttt{local ext=\$\{1:-\}} : extension vis√©e.
  \item[\textbf{L35--L38}] Validation de l'argument : usage sinon, retour code 2.
  \item[\textbf{L39}] En-t√™te d'information.
  \item[\textbf{L40}] \texttt{find . -type f -iname "*.\$\{ext\}"} : liste tous les fichiers de cette extension, sans tenir compte de la casse.
  \item[\textbf{L41}] Fin de la fonction.
\end{enumerate}

\subsection*{Dispatcher optionnel (comment√©) : L43--L48}
\begin{enumerate}
  \item[\textbf{L43--L48}] Bloc \texttt{case} montrant comment transformer le fichier en \emph{petit utilitaire} :
  \begin{itemize}
    \item \texttt{mtime} $\rightarrow$ \texttt{search\_mtime}
    \item \texttt{suspects <ext>} $\rightarrow$ \texttt{find\_suspects <ext>}
    \item \texttt{type <ext>} $\rightarrow$ \texttt{search\_for\_type <ext>}
    \item sinon, message d'usage et sortie avec code 1.
  \end{itemize}
  Les \texttt{shift} retirent le premier argument (la sous-commande) pour que l'argument suivant soit l'extension.
\end{enumerate}

\section{Notes de s√ªret√© et de portabilit√©}
\begin{itemize}
  \item \textbf{Pourquoi \texttt{BASH\_SOURCE} plut√¥t que \texttt{\$0} ?} \texttt{BASH\_SOURCE} donne le \emph{fichier} r√©ellement sourc√©, fiable dans les fonctions et lors d'un \texttt{source}. \texttt{\$0} peut pointer vers le shell ou un wrapper.
  \item \textbf{Pourquoi \texttt{printf} ?} \texttt{echo -e} a des divergences d'impl√©mentation selon les shells; \texttt{printf} est normalis√© POSIX.
  \item \textbf{Pourquoi \texttt{-print0}/\texttt{-0} ?} S√©curit√© face aux espaces, accents et retours ligne dans les chemins (sinon \texttt{xargs} s√©pare sur espaces).
  \item \textbf{Pourquoi \texttt{|| true} apr√®s \texttt{grep} ?} Avec \texttt{set -e}, un \texttt{grep} sans match retourne 1 et tuerait le script; ici on consid√®re ``aucun match'' comme un cas non fatal.
  \item \textbf{Casse insensible dans \texttt{grep}} : ajoutez \texttt{-i} √† \texttt{grep} si vous souhaitez ignorer la casse pour le texte (\texttt{-I} ne concerne que les binaires).
\end{itemize}

\section{Variantes utiles}
\begin{itemize}
  \item \textbf{Plusieurs extensions d'un coup} : remplacer la recherche par un motif √©tendu, ex. \texttt{-iregex '.*\textbackslash.(php\textbar js\textbar ts)'} ou it√©rer sur une liste d'extensions.
  \item \textbf{Rapport JSON/CSV} : canaliser la sortie \texttt{grep} vers un formateur (awk/python) pour produire un inventaire machine-readable.
  \item \textbf{Exclusion de dossiers} : ajouter \texttt{-not -path "./vendor/*"} ou \texttt{-prune} pour ignorer \texttt{.git}, \texttt{node\_modules}, etc.
\end{itemize}

\section{Exemples d'usage}
\begin{itemize}
  \item \textbf{Fichiers modifi√©s $<$24h} : appeler la fonction \texttt{search\_mtime}.
  \item \textbf{Termes suspects dans les \texttt{.php}} : \texttt{find\_suspects php}.
  \item \textbf{Lister tous les \texttt{.js}} : \texttt{search\_for\_type js}.
  \item \textbf{Avec le dispatcher (d√©comment√©)} :
  \begin{itemize}
    \item \texttt{./script.sh mtime}
    \item \texttt{./script.sh suspects js}
    \item \texttt{./script.sh type log}
  \end{itemize}
\end{itemize}

\end{document}
